<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>A sparklyr extension for nested data • sparklyr.nested</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<!-- pkgdown -->
<link href="pkgdown.css" rel="stylesheet">
<script src="jquery.sticky-kit.min.js"></script>
<script src="pkgdown.js"></script>
  
  
<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-vignette">
      <header>
      <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">sparklyr.nested</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/mitre/sparklyr.nested/issues">
    <span class="fa fa-question-circle fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/mitre/sparklyr.nested">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <script src="index_files/htmlwidgets-0.6/htmlwidgets.js"></script>
<link href="index_files/jsoneditor-5.5.5/jsoneditor.min.css" rel="stylesheet" />
<script src="index_files/jsoneditor-5.5.5/jsoneditor.min.js"></script>
<script src="index_files/jsonedit-binding-1.4.0/jsonedit.js"></script>

<div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>sparklyr.nested</h1>
            
          </div>

    
    
<div class="contents">
<p>A package to extend the capabilities available in the open source <code>sparklyr</code> package with support for working with nested data.</p>
<div id="nested-operations" class="section level2">
<h2>Nested Operations</h2>
<p>The <code>sparklyr</code> package makes working with Spark in R easy. The goal of this package is to extend <code>sparklyr</code> so that working with nested data is easy. The flagship functions are <code>sdf_select</code>, <code>sdf_explode</code>, <code>sdf_unnest</code>, and <code>sfd_schema_viewer</code>.</p>
<div id="schema-viewer" class="section level3">
<h3>Schema Viewer</h3>
<p>Suppose I have data about aircraft phase of flight (e.g., climb, cruise, descent). The data is somewhat complex, storing radar data points marked as the start and end points of a given phase. Furthermore, the data is structured such that for a given flight, there are several phases (disjoint in time) in a nested array.</p>
<p>This is a data set that is not very natural for more R use cases (though the <code>tidyr</code> package helps close this gap) but is fairly typical for Hadoop storage (e.g., using Avro or Parquet). The schema viewer (coupled with a json schema getter <code>sdf_schema_json</code>) makes understanding the structure of the data simple. The following example uses the mocking functionality from <code>testthat</code> so that the look and feel of the viewer can be shown without requiring a real spark connection. The key line is <code>sdf_schema_viewer(spark_data)</code> where <code>spark_data</code> is a Spark data frame.</p>
<pre><code>## Warning: Installed Rcpp (0.12.12) different from Rcpp used to build dplyr (0.12.10).
## Please reinstall dplyr to avoid random crashes or undefined behavior.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">with_mock</span>(
  <span class="co"># I am mocking functions so that the example works without a real spark connection</span>
  <span class="dt">spark_read_parquet =</span> function(x, ...){<span class="kw">return</span>(<span class="st">&quot;this is a spark dataframe&quot;</span>)},
  <span class="dt">sdf_schema_json =</span> function(x, ...){<span class="kw">return</span>(<span class="kw">fromJSON</span>(sample_json))},
  <span class="dt">spark_connect =</span> function(...){<span class="kw">return</span>(<span class="st">&quot;this is a spark connection&quot;</span>)},
  
  <span class="co"># the meat of the example is here</span>
  sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(),
  spark_data &lt;-<span class="st"> </span><span class="kw">spark_read_parquet</span>(sc, <span class="dt">path=</span><span class="st">&quot;path/to/data/*.parquet&quot;</span>, <span class="dt">name=</span><span class="st">&quot;some_name&quot;</span>),
  <span class="kw">sdf_schema_viewer</span>(spark_data)
)</code></pre></div>
<div id="htmlwidget-2881" style="width:672px;height:480px;" class="jsonedit html-widget"></div>
<script type="application/json" data-for="htmlwidget-2881">{"x":{"data":{"aircraft_id":"string","phase_sequence":"string","phases (array)":{"start_point (struct)":{"segment_phase":"string","agl":"double","elevation":"double","time":"long","latitude":"double","longitude":"double","altitude":"double","course":"double","speed":"double","source_point_keys (array)":"[string]","primary_key":"string"},"end_point (struct)":{"segment_phase":"string","agl":"double","elevation":"double","time":"long","latitude":"double","longitude":"double","altitude":"double","course":"double","speed":"double","source_point_keys (array)":"[string]","primary_key":"string"},"phase":"string","primary_key":"string"},"primary_key":"string"},"options":{"mode":"tree","modes":["code","form","text","tree","view"]}},"evals":[],"jsHooks":[]}</script>
<p>This example only goes a few levels deep. This is not a restriction though. Arbitrarily complex data structures are handled.</p>
</div>
<div id="nested-select" class="section level3">
<h3>Nested Select</h3>
<p>The <code>sdf_select</code> function makes it possible to select nested elements. For example, given the schema displayed above, we may be interested in only the phase end point; and there only the time and altitude fields. Grabbing these elements is not possible with a simple <code>select</code>, but can be done via:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spark_data %&gt;%
<span class="st">  </span><span class="kw">sdf_select</span>(aircraft_id, <span class="dt">time=</span>phases.end_point.time, <span class="dt">altitude=</span>phases.end_point.altitude)</code></pre></div>
<p>In java dots are not valid characters in a field name so the dot-operator is handled. However, since the dollar sign is typically used for this purpose in R, that is supported as well. The following will trigger the same operation as the above:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spark_data %&gt;%
<span class="st">  </span><span class="kw">sdf_select</span>(aircraft_id, <span class="dt">time=</span>phases$end_point$time, <span class="dt">altitude=</span>phases$end_point$altitude)</code></pre></div>
</div>
<div id="explode" class="section level3">
<h3>Explode</h3>
<p>The example above would work, but would return something of a mess. The <code>time</code> and <code>altitude</code> fields would contain vectors of time and altitude values (respectively) for each row-wise element. Thus for a single <code>aircraft_id</code> you would have N values in the corresponding <code>time</code> and <code>altitude</code> fields. The explode functionality will flatten the data in the sense that it will replicate the top level record once for each element in a nested array along which you are exploding. It will <em>not</em> change the schema beyond transforming arrays to structures.</p>
<p>The above example could be repeated like so to get something more typical for R where there is a single value per field per “row” (record). In this case the <code>aircraft_id</code> values would be replicated N times instead of having vectors in the <code>time</code>/<code>altitude</code> fields.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spark_data %&gt;%
<span class="st">  </span><span class="kw">sdf_explode</span>(phases) %&gt;%
<span class="st">  </span><span class="kw">sdf_select</span>(aircraft_id, <span class="dt">time=</span>phases$end_point$time, <span class="dt">altitude=</span>phases$end_point$altitude)</code></pre></div>
</div>
<div id="unnest" class="section level3">
<h3>Unnest</h3>
<p>Unnesting here works essentially the same way as in the <code>tidyr</code> package. It is necessary here because <code>tidyr</code> functions cannot be called directly on spark data frames. An unnest operation is a combination of an explode with a corresponding nested select to promote the (exploded) nested fields up one level of the data schema.</p>
<p>Thus the following operations are equivalent:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spark_data %&gt;%
<span class="st">  </span><span class="kw">sdf_unnest</span>(phases)</code></pre></div>
<p>and</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spark_data %&gt;%
<span class="st">  </span><span class="kw">sdf_explode</span>(phases) %&gt;%
<span class="st">  </span><span class="kw">sdf_select</span>(aircraft_id, terrain_fusion_key, vertical_taxonomy_key, sequence, 
             <span class="dt">start_point=</span>phases.start_point, <span class="dt">end_point=</span>phases.end_point, <span class="dt">phase=</span>phases.phase,
             <span class="dt">takeoff_mode=</span>phases.takeoff_model, <span class="dt">landing_model=</span>phases.landing_model, 
             <span class="dt">phases_primary_key=</span>phases.primary_key, primary_key)</code></pre></div>
<p>There are a few things to notice about how <code>sdf_unnest</code> does things:</p>
<ul>
<li><p>It will only dig one level deep into the schema. If there are fields nested 2 levels deep, they will still be nested (albeit only down 1 level) after <code>sdf_unnest</code> is executed. Therefore you are <em>not</em> guaranteed totally flat data after calling <code>sdf_unnest</code>.</p></li>
<li><p>It will promote <em>every</em> one-level-deep field, even if you only care about a few of them.</p></li>
<li><p>In the event of a name conflict (e.g., there is a top level <code>primary_key</code> and a <code>primary_key</code> nested inside the <code>phases</code> field) then the nested field will be renamed with a prepended value. By default this takes the name of the field in which it was nested (as above) but is settable.</p></li>
</ul>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Links</h2><ul class='list-unstyled'>
<li>Source at <br /><a href='https://github.com/mitre/sparklyr.nested'>https://&#8203;github.com/&#8203;mitre/&#8203;sparklyr.nested</a></li>
</ul>
<h2>License</h2>
<p>Apache License 2.0 | file <a href='LICENSE.html'>LICENSE</a></p>
<h2>Developers</h2><ul class='list-unstyled'>
<li>Matt Pollock <br />
<small class = 'roles'> Author, maintainer </small> </li>
<li><a href='authors.html'>All authors...</li></li>
</ul>

      </div>

</div>


      <footer>
      <div class="copyright">
  <p>Developed by Matt Pollock.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  </body>
</html>
