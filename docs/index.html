<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A sparklyr extension for nested data • sparklyr.nested</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="A sparklyr extension for nested data">
<meta property="og:description" content="A sparklyr extension adding the capability to work easily with nested data using
             dot and dollar sign notation.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">sparklyr.nested</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Change Log</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mitre/sparklyr.nested/issues">
    <span class="fa fa-question-circle fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/mitre/sparklyr.nested">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><script src="index_files/htmlwidgets-1.2/htmlwidgets.js"></script><link href="index_files/jsoneditor-5.5.5/jsoneditor.min.css" rel="stylesheet">
<script src="index_files/jsoneditor-5.5.5/jsoneditor.min.js"></script><script src="index_files/jsonedit-binding-2.0.0/jsonedit.js"></script><div class="row">
  <div class="col-md-9 contents">
    

    
    

<p>A package to extend the capabilities available in the <code>sparklyr</code> package with support for working with nested data.</p>
<div id="installation-documentation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation-documentation" class="anchor"></a>Installation &amp; Documentation</h2>
<p>To install:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"mitre/sparklyr.nested"</span>)</a></code></pre></div>
<p>Note that per the <code>sparklyr</code> installation instructions, you will need to install Spark if you have not already done so or are not using a cluster where it is already installed.</p>
</div>
<div id="nested-operations" class="section level2">
<h2 class="hasAnchor">
<a href="#nested-operations" class="anchor"></a>Nested Operations</h2>
<p>The <code>sparklyr</code> package makes working with Spark in R easy. The goal of this package is to extend <code>sparklyr</code> so that working with nested data is easy. The flagship functions are <code>sdf_select</code>, <code>sdf_explode</code>, <code>sdf_unnest</code>, and <code>sfd_schema_viewer</code>.</p>
<div id="schema-viewer" class="section level3">
<h3 class="hasAnchor">
<a href="#schema-viewer" class="anchor"></a>Schema Viewer</h3>
<p>Suppose I have data about aircraft phase of flight (e.g., climb, cruise, descent). The data is somewhat complex, storing radar data points marked as the start and end points of a given phase. Furthermore, the data is structured such that for a given flight, there are several phases (disjoint in time) in a nested array.</p>
<p>This is a data set that is not very natural for more R use cases (though the <code>tidyr</code> package helps close this gap) but is fairly typical for Hadoop storage (e.g., using Avro or Parquet). The schema viewer (coupled with a json schema getter <code>sdf_schema_json</code>) makes understanding the structure of the data simple.</p>
<p>Suppose that <code>spark_data</code> is a Spark data frame. The following is mostly a bunch of code to simulate a <code>sparklyr</code> environment where no actual spark connection exists, but the key bit at the end shows how the <code>listviewer</code> package with some schema parsing yields an effective view of how the data is structured.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">library</span>(testthat)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">library</span>(jsonlite)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">library</span>(sparklyr)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">library</span>(sparklyr.nested)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw"><a href="http://www.rdocumentation.org/packages/testthat/topics/with_mock">with_mock</a></span>(</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="co"># I am mocking functions so that the example works without a real spark connection</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  <span class="dt">spark_read_parquet =</span> <span class="cf">function</span>(x, ...){<span class="kw">return</span>(<span class="st">"this is a spark dataframe"</span>)},</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  <span class="dt">sdf_schema_json =</span> <span class="cf">function</span>(x, ...){<span class="kw">return</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/jsonlite/topics/fromJSON">fromJSON</a></span>(sample_json))},</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  <span class="dt">spark_connect =</span> <span class="cf">function</span>(...){<span class="kw">return</span>(<span class="st">"this is a spark connection"</span>)},</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  </a>
<a class="sourceLine" id="cb2-13" data-line-number="13">  <span class="co"># -- interesting part starts here -------------------</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb2-15" data-line-number="15">  sc &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/sparklyr/topics/spark-connections">spark_connect</a></span>(),  </a>
<a class="sourceLine" id="cb2-16" data-line-number="16">  spark_data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/sparklyr/topics/spark_read_parquet">spark_read_parquet</a></span>(sc, <span class="dt">path=</span><span class="st">"path/to/data/*.parquet"</span>, <span class="dt">name=</span><span class="st">"some_name"</span>),</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">  <span class="kw"><a href="reference/sdf_schema_json.html">sdf_schema_viewer</a></span>(spark_data)</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">)</a></code></pre></div>
<div id="htmlwidget-cde15b0ca17e9e152ccb" style="width:700px;height:432.632880098888px;" class="jsonedit html-widget"></div>
<script type="application/json" data-for="htmlwidget-cde15b0ca17e9e152ccb">{"x":{"data":{"aircraft_id":"string","phase_sequence":"string","phases (array)":{"start_point (struct)":{"segment_phase":"string","agl":"double","elevation":"double","time":"long","latitude":"double","longitude":"double","altitude":"double","course":"double","speed":"double","source_point_keys (array)":"[string]","primary_key":"string"},"end_point (struct)":{"segment_phase":"string","agl":"double","elevation":"double","time":"long","latitude":"double","longitude":"double","altitude":"double","course":"double","speed":"double","source_point_keys (array)":"[string]","primary_key":"string"},"phase":"string","primary_key":"string"},"primary_key":"string"},"options":{"mode":"tree","modes":["code","form","text","tree","view"]}},"evals":[],"jsHooks":[]}</script><p>It is also handy to use the schema viewer to quickly inspect what a pipeline of operations is going to return. This enables you to anticipate the structure of the output you are going to get (and make sure the operations are valid with respect to schema modification) without doing any actual computation on your data. For example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">spark_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="reference/sdf_unnest.html">sdf_unnest</a></span>(phases) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(aircraft_id, start_point) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="reference/sdf_schema_json.html">sdf_schema_viewer</a></span>()</a></code></pre></div>
</div>
<div id="nested-select" class="section level3">
<h3 class="hasAnchor">
<a href="#nested-select" class="anchor"></a>Nested Select</h3>
<p>The <code>sdf_select</code> function makes it possible to select nested elements. For example, given the schema displayed above, we may be interested in only the phase start point; and within that, only the time and altitude fields. Grabbing these elements is not possible with a simple <code>select</code>, but can be done via:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">spark_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="reference/sdf_select.html">sdf_select</a></span>(aircraft_id, <span class="dt">time=</span>phases.start_point.time, <span class="dt">altitude=</span>phases.start_point.altitude)</a></code></pre></div>
<p>In java dots are not valid characters in a field name so the dot-operator is handled. However, since the dollar sign is typically used for this purpose in R, that is supported as well. The following will trigger the same operation as the above:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">spark_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="reference/sdf_select.html">sdf_select</a></span>(aircraft_id, <span class="dt">time=</span>phases<span class="op">$</span>start_point<span class="op">$</span>time, <span class="dt">altitude=</span>phases<span class="op">$</span>start_point<span class="op">$</span>altitude)</a></code></pre></div>
<p>What if you want to keep all top level fields, except phases, from which you still want to start point time and altitude? This can be accomplished via:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">spark_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="reference/sdf_select.html">sdf_select</a></span>(aircraft_id, phase_sequence, primary_key, </a>
<a class="sourceLine" id="cb6-3" data-line-number="3">             <span class="dt">time=</span>phases<span class="op">$</span>start_point<span class="op">$</span>time, <span class="dt">altitude=</span>phases<span class="op">$</span>start_point<span class="op">$</span>altitude)</a></code></pre></div>
<p>In this particular example things are not so bad. But imagine a case where you have a wide data set. Listing out each top level field would quickly become cumbersome. To ease this pain, the <code>dplyr</code> selection helpers are supported, so the above operation may be accomplished using:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">spark_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="reference/sdf_select.html">sdf_select</a></span>(<span class="kw">everything</span>(), <span class="dt">time=</span>phases<span class="op">$</span>start_point<span class="op">$</span>time, <span class="dt">altitude=</span>phases<span class="op">$</span>start_point<span class="op">$</span>altitude)</a></code></pre></div>
</div>
<div id="explode" class="section level3">
<h3 class="hasAnchor">
<a href="#explode" class="anchor"></a>Explode</h3>
<p>The example above would work, but would return something of a mess. The <code>time</code> and <code>altitude</code> fields would contain vectors of time and altitude values (respectively) for each row-wise element. Thus for a single <code>aircraft_id</code> you would have N values in the corresponding <code>time</code> and <code>altitude</code> fields. The explode functionality will flatten the data in the sense that it will replicate the top level record once for each element in a nested array along which you are exploding. It will <em>not</em> change the schema beyond transforming arrays to structures.</p>
<p>The above example could be repeated like so to get something more typical for R where there is a single value per field per “row” (record). In this case the <code>aircraft_id</code> values would be replicated N times instead of having vectors in the <code>time</code>/<code>altitude</code> fields.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">spark_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="reference/sdf_explode.html">sdf_explode</a></span>(phases) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="reference/sdf_select.html">sdf_select</a></span>(aircraft_id, <span class="dt">time=</span>phases<span class="op">$</span>start_point<span class="op">$</span>time, <span class="dt">altitude=</span>phases<span class="op">$</span>start_point<span class="op">$</span>altitude)</a></code></pre></div>
</div>
<div id="unnest" class="section level3">
<h3 class="hasAnchor">
<a href="#unnest" class="anchor"></a>Unnest</h3>
<p>Unnesting here works essentially the same way as in the <code>tidyr</code> package. It is necessary here because <code>tidyr</code> functions cannot be called directly on spark data frames. An unnest operation is a combination of an explode with a corresponding nested select to promote the (exploded) nested fields up one level of the data schema.</p>
<p>Thus the following operations are equivalent:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">spark_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="reference/sdf_unnest.html">sdf_unnest</a></span>(phases)</a></code></pre></div>
<p>and</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">spark_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="reference/sdf_explode.html">sdf_explode</a></span>(phases) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="reference/sdf_select.html">sdf_select</a></span>(aircraft_id, terrain_fusion_key, vertical_taxonomy_key, sequence, </a>
<a class="sourceLine" id="cb10-4" data-line-number="4">             <span class="dt">start_point=</span>phases.start_point, <span class="dt">start_point=</span>phases.start_point, <span class="dt">phase=</span>phases.phase,</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">             <span class="dt">takeoff_mode=</span>phases.takeoff_model, <span class="dt">landing_model=</span>phases.landing_model, </a>
<a class="sourceLine" id="cb10-6" data-line-number="6">             <span class="dt">phases_primary_key=</span>phases.primary_key, primary_key)</a></code></pre></div>
<p>There are a few things to notice about how <code>sdf_unnest</code> does things:</p>
<ul>
<li><p>It will only dig one level deep into the schema. If there are fields nested 2 levels deep, they will still be nested (albeit only down 1 level) after <code>sdf_unnest</code> is executed. Therefore you are <em>not</em> guaranteed totally flat data after calling <code>sdf_unnest</code>.</p></li>
<li><p>It will promote <em>every</em> one-level-deep field, even if you only care about a few of them.</p></li>
<li><p>In the event of a name conflict (e.g., there is a top level <code>primary_key</code> and a <code>primary_key</code> nested inside the <code>phases</code> field) then all of the nested fields will be disambuigated using the name of the field in which it was nested.</p></li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Report a bug at <br><a href="https://github.com/mitre/sparklyr.nested/issues">https://​github.com/​mitre/​sparklyr.nested/​issues</a>
</li>
<li>Source at <br><a href="https://github.com/mitre/sparklyr.nested">https://​github.com/​mitre/​sparklyr.nested</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>Apache License 2.0 | file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Matt Pollock <br><small class="roles"> Author, maintainer </small>  </li>
<li><a href="authors.html">All authors...</a></li>
</ul>
</div>

      <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://travis-ci.org/mitre/sparklyr.nested"><img src="https://travis-ci.org/mitre/sparklyr.nested.svg?branch=master" alt="Build Status"></a></li>
</ul>
</div>
</div>

</div>


      <footer><div class="copyright">
  <p>Developed by Matt Pollock.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
